// =========================================
// 1. CONFIGURACI칍N Y DATOS (CONSTANTES GLOBALES)
// =========================================

/**
 * @constant {Array<[number, number]>} HAND_CONNECTIONS - Define las conexiones entre los puntos de referencia de la mano.
 * Cada elemento del array es un par de 칤ndices que representan una conexi칩n.
 */
const HAND_CONNECTIONS = [
  [0, 1], [1, 2], [2, 3], [3, 4], // Pulgar
  [0, 5], [5, 6], [6, 7], [7, 8], // 칈ndice
  [5, 9], [9, 10], [10, 11], [11, 12], // Medio
  [9, 13], [13, 14], [14, 15], [15, 16], // Anular
  [13, 17], [17, 18], [18, 19], [19, 20], // Me침ique
  [0, 17] // Conexi칩n de la palma
];

/**
 * @constant {string} avatarURL - URL por defecto para el avatar del usuario.
 * @default "https://i.imgur.com/0y8Ftya.png"
 * @see [cite:456] 
 */
// CAMBIO RECOMENDADO: Usar un servicio de avatares p칰blico o una imagen local
// const avatarURL = "https://i.imgur.com/0y8Ftya.png"; // <-- Esta da error 403
const avatarURL = "https://via.placeholder.com/150?text=Usuario";
// O si descargaste la imagen: const avatarURL = "img/avatar_default.png";
/**
 * @constant {Array<string>} abecedario - Array que contiene las letras del abecedario para el entrenamiento.
 */
const abecedario = [
  "A", "B", "C", "CH", "D", "E", "F", "G", "H", "I", "J", "K", "L", "LL",
  "M", "N", "칌", "O", "P", "Q", "R", "RR", "S", "T", "U", "V", "W", "X", "Y", "Z"
];


const ejemplosGuardados = [
  {
    letra: "A",
    puntos: [
      { x: "0.1717", y: "0.7938", z: "-0.0000" },
      { x: "0.2658", y: "0.7457", z: "-0.0149" },
      { x: "0.3445", y: "0.6541", z: "-0.0202" },
      { x: "0.4038", y: "0.6003", z: "-0.0262" },
      { x: "0.4546", y: "0.5893", z: "-0.0250" },
      { x: "0.2882", y: "0.5419", z: "-0.0068" },
      { x: "0.3262", y: "0.4858", z: "-0.0321" },
      { x: "0.3033", y: "0.5708", z: "-0.0371" },
      { x: "0.2839", y: "0.5813", z: "-0.0399" },
      { x: "0.2366", y: "0.5327", z: "-0.0144" },
      { x: "0.2790", y: "0.4720", z: "-0.0482" },
      { x: "0.2634", y: "0.5772", z: "-0.0498" },
      { x: "0.2409", y: "0.5834", z: "-0.0451" },
      { x: "0.1829", y: "0.5393", z: "-0.0254" },
      { x: "0.2226", y: "0.4763", z: "-0.0605" },
      { x: "0.2212", y: "0.5812", z: "-0.0412" },
      { x: "0.1994", y: "0.5948", z: "-0.0214" },
      { x: "0.1276", y: "0.5559", z: "-0.0371" },
      { x: "0.1655", y: "0.5106", z: "-0.0565" },
      { x: "0.1766", y: "0.5826", z: "-0.0373" },
      { x: "0.1582", y: "0.5992", z: "-0.0191" }
    ]
  },
  {
    letra: "B",
    puntos: [
      { x: "0.1786", y: "0.7239", z: "0.0000" },
      { x: "0.2541", y: "0.6930", z: "-0.0282" },
      { x: "0.3105", y: "0.6175", z: "-0.0352" },
      { x: "0.2890", y: "0.5385", z: "-0.0410" },
      { x: "0.2388", y: "0.5161", z: "-0.0469" },
      { x: "0.2986", y: "0.4776", z: "-0.0063" },
      { x: "0.3178", y: "0.3811", z: "-0.0191" },
      { x: "0.3261", y: "0.3215", z: "-0.0343" },
      { x: "0.3326", y: "0.2684", z: "-0.0474" },
      { x: "0.2582", y: "0.4555", z: "-0.0082" },
      { x: "0.2768", y: "0.3469", z: "-0.0188" },
      { x: "0.2861", y: "0.2730", z: "-0.0357" },
      { x: "0.2922", y: "0.2128", z: "-0.0495" },
      { x: "0.2183", y: "0.4592", z: "-0.0147" },
      { x: "0.2344", y: "0.3565", z: "-0.0278" },
      { x: "0.2459", y: "0.2872", z: "-0.0460" },
      { x: "0.2529", y: "0.2298", z: "-0.0593" },
      { x: "0.1727", y: "0.4822", z: "-0.0245" },
      { x: "0.1802", y: "0.4014", z: "-0.0383" },
      { x: "0.1864", y: "0.3447", z: "-0.0483" },
      { x: "0.1898", y: "0.2927", z: "-0.0561" }
    ]
  },
  {
    letra: "C",
    puntos: [
      { x: "0.2193", y: "0.6384", z: "0.0000" },
      { x: "0.3152", y: "0.6268", z: "0.0300" },
      { x: "0.3845", y: "0.5883", z: "0.0397" },
      { x: "0.4336", y: "0.5693", z: "0.0350" },
      { x: "0.4630", y: "0.5406", z: "0.0296" },
      { x: "0.3607", y: "0.4111", z: "0.0594" },
      { x: "0.3957", y: "0.3164", z: "0.0482" },
      { x: "0.4411", y: "0.3084", z: "0.0327" },
      { x: "0.4737", y: "0.3301", z: "0.0234" },
      { x: "0.3409", y: "0.3997", z: "0.0258" },
      { x: "0.3848", y: "0.2821", z: "0.0082" },
      { x: "0.4436", y: "0.2914", z: "-0.0126" },
      { x: "0.4758", y: "0.3415", z: "-0.0227" },
      { x: "0.3197", y: "0.3967", z: "-0.0108" },
      { x: "0.3669", y: "0.2825", z: "-0.0288" },
      { x: "0.4254", y: "0.2977", z: "-0.0423" },
      { x: "0.4583", y: "0.3433", z: "-0.0471" },
      { x: "0.3017", y: "0.4102", z: "-0.0465" },
      { x: "0.3487", y: "0.3225", z: "-0.0639" },
      { x: "0.3963", y: "0.3144", z: "-0.0723" },
      { x: "0.4291", y: "0.3351", z: "-0.0748" }
    ]
  },
 {
  letra: "CH",
  puntos: [
    { x: "0.1156", y: "0.8322", z: "0.0000" },
    { x: "0.1561", y: "0.7282", z: "0.0097" },
    { x: "0.2148", y: "0.6353", z: "-0.0039" },
    { x: "0.2496", y: "0.5575", z: "-0.0220" },
    { x: "0.2582", y: "0.4825", z: "-0.0401" },
    { x: "0.2812", y: "0.6258", z: "-0.0474" },
    { x: "0.3876", y: "0.5865", z: "-0.0729" },
    { x: "0.4488", y: "0.5557", z: "-0.0841" },
    { x: "0.4971", y: "0.5324", z: "-0.0918" },
    { x: "0.2818", y: "0.6857", z: "-0.0691" },
    { x: "0.4070", y: "0.7226", z: "-0.0971" },
    { x: "0.4683", y: "0.7553", z: "-0.1017" },
    { x: "0.5110", y: "0.7775", z: "-0.1052" },
    { x: "0.2752", y: "0.7632", z: "-0.0861" },
    { x: "0.3682", y: "0.8278", z: "-0.1070" },
    { x: "0.3311", y: "0.8415", z: "-0.0870" },
    { x: "0.2882", y: "0.8333", z: "-0.0713" },
    { x: "0.2662", y: "0.8418", z: "-0.1025" },
    { x: "0.3290", y: "0.8837", z: "-0.1116" },
    { x: "0.3000", y: "0.8842", z: "-0.0911" },
    { x: "0.2666", y: "0.8675", z: "-0.0743" }
  ]
},
{
  letra: "E",
  puntos: [
    { x: "0.1751", y: "0.8011", z: "0.0000" },
    { x: "0.2507", y: "0.7725", z: "-0.0258" },
    { x: "0.3117", y: "0.7152", z: "-0.0506" },
    { x: "0.3311", y: "0.6675", z: "-0.0774" },
    { x: "0.2957", y: "0.6263", z: "-0.1041" },
    { x: "0.2583", y: "0.5473", z: "-0.0406" },
    { x: "0.2619", y: "0.4200", z: "-0.0834" },
    { x: "0.2970", y: "0.4436", z: "-0.1181" },
    { x: "0.3079", y: "0.5038", z: "-0.1350" },
    { x: "0.2170", y: "0.5477", z: "-0.0488" },
    { x: "0.2159", y: "0.3933", z: "-0.0830" },
    { x: "0.2570", y: "0.4277", z: "-0.1129" },
    { x: "0.2693", y: "0.4940", z: "-0.1305" },
    { x: "0.1753", y: "0.5592", z: "-0.0597" },
    { x: "0.1682", y: "0.4176", z: "-0.0821" },
    { x: "0.2102", y: "0.4408", z: "-0.0993" },
    { x: "0.2259", y: "0.5042", z: "-0.1094" },
    { x: "0.1304", y: "0.5842", z: "-0.0733" },
    { x: "0.1273", y: "0.4805", z: "-0.0927" },
    { x: "0.1625", y: "0.4792", z: "-0.1029" },
    { x: "0.1843", y: "0.5167", z: "-0.1088" }
  ]
},
{
  letra: "F",
  puntos: [
    { x: "0.2404", y: "0.9242", z: "0.0000" },
    { x: "0.3012", y: "0.8755", z: "-0.0160" },
    { x: "0.3568", y: "0.7938", z: "-0.0280" },
    { x: "0.3989", y: "0.7311", z: "-0.0428" },
    { x: "0.4276", y: "0.6791", z: "-0.0569" },
    { x: "0.2992", y: "0.6658", z: "-0.0065" },
    { x: "0.3461", y: "0.6100", z: "-0.0396" },
    { x: "0.3836", y: "0.6134", z: "-0.0672" },
    { x: "0.4127", y: "0.6343", z: "-0.0822" },
    { x: "0.2618", y: "0.6397", z: "-0.0185" },
    { x: "0.2934", y: "0.5355", z: "-0.0397" },
    { x: "0.3238", y: "0.4669", z: "-0.0555" },
    { x: "0.3488", y: "0.4076", z: "-0.0654" },
    { x: "0.2203", y: "0.6433", z: "-0.0370" },
    { x: "0.2131", y: "0.5230", z: "-0.0655" },
    { x: "0.2127", y: "0.4400", z: "-0.0889" },
    { x: "0.2165", y: "0.3692", z: "-0.1024" },
    { x: "0.1815", y: "0.6770", z: "-0.0567" },
    { x: "0.1326", y: "0.6022", z: "-0.0846" },
    { x: "0.0985", y: "0.5556", z: "-0.0978" },
    { x: "0.0726", y: "0.5104", z: "-0.1048" }
  ]
},
{
  letra: "G",
  puntos: [
    { x: "0.0925", y: "0.6113", z: "0.0000" },
    { x: "0.1611", y: "0.4943", z: "-0.0135" },
    { x: "0.2822", y: "0.4384", z: "-0.0386" },
    { x: "0.3888", y: "0.4439", z: "-0.0584" },
    { x: "0.4620", y: "0.4401", z: "-0.0769" },
    { x: "0.2659", y: "0.4142", z: "-0.0984" },
    { x: "0.4223", y: "0.4516", z: "-0.1300" },
    { x: "0.5027", y: "0.4712", z: "-0.1386" },
    { x: "0.5604", y: "0.4877", z: "-0.1414" },
    { x: "0.2385", y: "0.5207", z: "-0.1097" },
    { x: "0.4149", y: "0.5611", z: "-0.1488" },
    { x: "0.4435", y: "0.5599", z: "-0.1444" },
    { x: "0.4407", y: "0.5519", z: "-0.1358" },
    { x: "0.2201", y: "0.6271", z: "-0.1160" },
    { x: "0.3874", y: "0.6652", z: "-0.1413" },
    { x: "0.4052", y: "0.6448", z: "-0.1184" },
    { x: "0.3973", y: "0.6152", z: "-0.0986" },
    { x: "0.2102", y: "0.7235", z: "-0.1221" },
    { x: "0.3434", y: "0.7282", z: "-0.1297" },
    { x: "0.3496", y: "0.7028", z: "-0.1058" },
    { x: "0.3329", y: "0.6767", z: "-0.0863" }
  ]
},
{
  letra: "H",
  puntos: [
    { x: "0.1950", y: "0.8239", z: "0.0000" },
    { x: "0.2576", y: "0.7284", z: "0.0064" },
    { x: "0.3389", y: "0.7058", z: "-0.0027" },
    { x: "0.3978", y: "0.7433", z: "-0.0149" },
    { x: "0.4330", y: "0.7923", z: "-0.0272" },
    { x: "0.3914", y: "0.6893", z: "-0.0364" },
    { x: "0.4997", y: "0.7145", z: "-0.0554" },
    { x: "0.5632", y: "0.7319", z: "-0.0639" },
    { x: "0.6111", y: "0.7485", z: "-0.0674" },
    { x: "0.3916", y: "0.7632", z: "-0.0514" },
    { x: "0.5089", y: "0.7842", z: "-0.0656" },
    { x: "0.5756", y: "0.7952", z: "-0.0702" },
    { x: "0.6230", y: "0.8083", z: "-0.0736" },
    { x: "0.3783", y: "0.8430", z: "-0.0620" },
    { x: "0.4561", y: "0.8686", z: "-0.0692" },
    { x: "0.4253", y: "0.8577", z: "-0.0525" },
    { x: "0.3884", y: "0.8486", z: "-0.0386" },
    { x: "0.3561", y: "0.9136", z: "-0.0727" },
    { x: "0.4081", y: "0.9150", z: "-0.0684" },
    { x: "0.3841", y: "0.9030", z: "-0.0451" },
    { x: "0.3558", y: "0.8996", z: "-0.0258" }
  ]
},
{
  letra: "I",
  puntos: [
    { x: "0.3162", y: "0.8226", z: "-0.0000" },
    { x: "0.3950", y: "0.7714", z: "-0.0077" },
    { x: "0.4428", y: "0.6999", z: "-0.0124" },
    { x: "0.4615", y: "0.6357", z: "-0.0239" },
    { x: "0.4569", y: "0.5725", z: "-0.0301" },
    { x: "0.4030", y: "0.5951", z: "0.0176" },
    { x: "0.4464", y: "0.5318", z: "-0.0107" },
    { x: "0.4463", y: "0.6078", z: "-0.0251" },
    { x: "0.4288", y: "0.6673", z: "-0.0245" },
    { x: "0.3835", y: "0.5856", z: "0.0075" },
    { x: "0.4355", y: "0.5303", z: "-0.0319" },
    { x: "0.4257", y: "0.6192", z: "-0.0484" },
    { x: "0.3993", y: "0.6820", z: "-0.0460" },
    { x: "0.3573", y: "0.5742", z: "-0.0081" },
    { x: "0.4125", y: "0.5162", z: "-0.0466" },
    { x: "0.4118", y: "0.5991", z: "-0.0522" },
    { x: "0.3899", y: "0.6633", z: "-0.0400" },
    { x: "0.3246", y: "0.5647", z: "-0.0240" },
    { x: "0.3406", y: "0.4602", z: "-0.0405" },
    { x: "0.3549", y: "0.3954", z: "-0.0422" },
    { x: "0.3647", y: "0.3386", z: "-0.0370" }
  ]
},
{
  letra: "J",
  puntos: [
    { x: "0.0378", y: "0.6887", z: "-0.0000" },
    { x: "0.0822", y: "0.5473", z: "0.0240" },
    { x: "0.1558", y: "0.4695", z: "0.0278" },
    { x: "0.2333", y: "0.4599", z: "0.0272" },
    { x: "0.2790", y: "0.4999", z: "0.0300" },
    { x: "0.2107", y: "0.4481", z: "-0.0048" },
    { x: "0.3053", y: "0.4666", z: "-0.0011" },
    { x: "0.2815", y: "0.4983", z: "0.0141" },
    { x: "0.2445", y: "0.5089", z: "0.0272" },
    { x: "0.2344", y: "0.5391", z: "-0.0211" },
    { x: "0.3254", y: "0.5433", z: "-0.0142" },
    { x: "0.2993", y: "0.5704", z: "0.0004" },
    { x: "0.2658", y: "0.5829", z: "0.0104" },
    { x: "0.2478", y: "0.6295", z: "-0.0328" },
    { x: "0.3416", y: "0.6215", z: "-0.0283" },
    { x: "0.3197", y: "0.6420", z: "-0.0102" },
    { x: "0.2854", y: "0.6500", z: "0.0025" },
    { x: "0.2504", y: "0.7128", z: "-0.0417" },
    { x: "0.3542", y: "0.6912", z: "-0.0371" },
    { x: "0.4042", y: "0.6897", z: "-0.0231" },
    { x: "0.4392", y: "0.6898", z: "-0.0113" }
  ]
},
{
  letra: "K",
  puntos: [
    { x: "0.1433", y: "0.8311", z: "0.0000" },
    { x: "0.1513", y: "0.7068", z: "-0.0037" },
    { x: "0.2065", y: "0.5904", z: "-0.0244" },
    { x: "0.2768", y: "0.5224", z: "-0.0462" },
    { x: "0.3147", y: "0.4785", z: "-0.0660" },
    { x: "0.1777", y: "0.5298", z: "-0.0652" },
    { x: "0.2730", y: "0.4274", z: "-0.0967" },
    { x: "0.3228", y: "0.3668", z: "-0.1118" },
    { x: "0.3598", y: "0.3168", z: "-0.1220" },
    { x: "0.2003", y: "0.5987", z: "-0.0845" },
    { x: "0.3398", y: "0.5459", z: "-0.1203" },
    { x: "0.4168", y: "0.5242", z: "-0.1270" },
    { x: "0.4688", y: "0.5015", z: "-0.1322" },
    { x: "0.2299", y: "0.6772", z: "-0.0997" },
    { x: "0.3496", y: "0.6567", z: "-0.1252" },
    { x: "0.3264", y: "0.7023", z: "-0.1010" },
    { x: "0.2893", y: "0.7259", z: "-0.0830" },
    { x: "0.2657", y: "0.7566", z: "-0.1163" },
    { x: "0.3533", y: "0.7303", z: "-0.1254" },
    { x: "0.3286", y: "0.7650", z: "-0.0991" },
    { x: "0.2963", y: "0.7849", z: "-0.0788" }
  ]
},
{
  letra: "L",
  puntos: [
    { x: "0.2066", y: "0.8935", z: "-0.0000" },
    { x: "0.2854", y: "0.8517", z: "-0.0106" },
    { x: "0.3502", y: "0.7679", z: "-0.0275" },
    { x: "0.3970", y: "0.7212", z: "-0.0500" },
    { x: "0.4441", y: "0.7064", z: "-0.0720" },
    { x: "0.3106", y: "0.6015", z: "-0.0303" },
    { x: "0.3538", y: "0.5009", z: "-0.0673" },
    { x: "0.3820", y: "0.4350", z: "-0.0889" },
    { x: "0.4023", y: "0.3742", z: "-0.1052" },
    { x: "0.2550", y: "0.5828", z: "-0.0465" },
    { x: "0.3281", y: "0.6361", z: "-0.0988" },
    { x: "0.3214", y: "0.7268", z: "-0.1082" },
    { x: "0.2943", y: "0.7510", z: "-0.1065" },
    { x: "0.2082", y: "0.6093", z: "-0.0644" },
    { x: "0.2853", y: "0.6892", z: "-0.1132" },
    { x: "0.2773", y: "0.7636", z: "-0.1053" },
    { x: "0.2515", y: "0.7682", z: "-0.0920" },
    { x: "0.1704", y: "0.6592", z: "-0.0840" },
    { x: "0.2385", y: "0.7405", z: "-0.1148" },
    { x: "0.2401", y: "0.7922", z: "-0.1096" },
    { x: "0.2195", y: "0.7881", z: "-0.1000" }
  ]
},
{
  letra: "LL",
  puntos: [
    { x: "0.4562", y: "0.7049", z: "0.0000" },
    { x: "0.5142", y: "0.7075", z: "0.0066" },
    { x: "0.5654", y: "0.6959", z: "-0.0021" },
    { x: "0.6079", y: "0.7119", z: "-0.0201" },
    { x: "0.6364", y: "0.7391", z: "-0.0389" },
    { x: "0.5654", y: "0.5421", z: "0.0189" },
    { x: "0.6055", y: "0.5047", z: "0.0016" },
    { x: "0.6343", y: "0.4781", z: "-0.0092" },
    { x: "0.6603", y: "0.4592", z: "-0.0164" },
    { x: "0.5491", y: "0.5210", z: "-0.0007" },
    { x: "0.6207", y: "0.5670", z: "-0.0343" },
    { x: "0.5913", y: "0.6298", z: "-0.0386" },
    { x: "0.5582", y: "0.6559", z: "-0.0307" },
    { x: "0.5335", y: "0.5133", z: "-0.0230" },
    { x: "0.5968", y: "0.5770", z: "-0.0543" },
    { x: "0.5607", y: "0.6306", z: "-0.0471" },
    { x: "0.5279", y: "0.6475", z: "-0.0317" },
    { x: "0.5170", y: "0.5180", z: "-0.0459" },
    { x: "0.5712", y: "0.5721", z: "-0.0614" },
    { x: "0.5518", y: "0.6153", z: "-0.0526" },
    { x: "0.5273", y: "0.6298", z: "-0.0404" }
  ]
},
{
  letra: "M",
  puntos: [
    { x: "0.2756", y: "0.5908", z: "0.0000" },
    { x: "0.3449", y: "0.6074", z: "-0.0172" },
    { x: "0.3895", y: "0.6241", z: "-0.0427" },
    { x: "0.4120", y: "0.6650", z: "-0.0698" },
    { x: "0.4271", y: "0.7208", z: "-0.0967" },
    { x: "0.4234", y: "0.4976", z: "-0.0481" },
    { x: "0.4295", y: "0.6068", z: "-0.0934" },
    { x: "0.4082", y: "0.6614", z: "-0.1069" },
    { x: "0.3865", y: "0.6996", z: "-0.1117" },
    { x: "0.3753", y: "0.4976", z: "-0.0577" },
    { x: "0.3796", y: "0.6036", z: "-0.1022" },
    { x: "0.3613", y: "0.6603", z: "-0.1107" },
    { x: "0.3420", y: "0.7013", z: "-0.1094" },
    { x: "0.3273", y: "0.5024", z: "-0.0647" },
    { x: "0.3283", y: "0.5996", z: "-0.1052" },
    { x: "0.3123", y: "0.6577", z: "-0.1062" },
    { x: "0.2961", y: "0.6992", z: "-0.0997" },
    { x: "0.2786", y: "0.5142", z: "-0.0707" },
    { x: "0.2779", y: "0.5924", z: "-0.0982" },
    { x: "0.2672", y: "0.6429", z: "-0.0963" },
    { x: "0.2574", y: "0.6814", z: "-0.0891" }
  ]
},
{
  letra: "N",
  puntos: [
    { x: "0.2382", y: "0.8323", z: "0.0000" },
    { x: "0.3042", y: "0.7834", z: "-0.0163" },
    { x: "0.3514", y: "0.7032", z: "-0.0303" },
    { x: "0.3742", y: "0.6354", z: "-0.0483" },
    { x: "0.3822", y: "0.5712", z: "-0.0636" },
    { x: "0.3276", y: "0.5842", z: "-0.0163" },
    { x: "0.3682", y: "0.5213", z: "-0.0457" },
    { x: "0.3681", y: "0.5982", z: "-0.0612" },
    { x: "0.3512", y: "0.6592", z: "-0.0613" },
    { x: "0.3054", y: "0.5773", z: "-0.0252" },
    { x: "0.3472", y: "0.5152", z: "-0.0577" },
    { x: "0.3463", y: "0.5923", z: "-0.0723" },
    { x: "0.3282", y: "0.6523", z: "-0.0701" },
    { x: "0.2823", y: "0.5732", z: "-0.0332" },
    { x: "0.3242", y: "0.5112", z: "-0.0643" },
    { x: "0.3232", y: "0.5872", z: "-0.0772" },
    { x: "0.3052", y: "0.6462", z: "-0.0732" },
    { x: "0.2582", y: "0.5672", z: "-0.0402" },
    { x: "0.3002", y: "0.5052", z: "-0.0682" },
    { x: "0.2992", y: "0.5802", z: "-0.0782" },
    { x: "0.2812", y: "0.6372", z: "-0.0722" }
  ]
},
{
  letra: "칌",
  puntos: [
    { x: "0.2482", y: "0.8423", z: "0.0000" },
    { x: "0.3142", y: "0.7934", z: "-0.0163" },
    { x: "0.3614", y: "0.7132", z: "-0.0303" },
    { x: "0.3842", y: "0.6454", z: "-0.0483" },
    { x: "0.3922", y: "0.5812", z: "-0.0636" },
    { x: "0.3376", y: "0.5942", z: "-0.0163" },
    { x: "0.3782", y: "0.5313", z: "-0.0457" },
    { x: "0.3781", y: "0.6082", z: "-0.0612" },
    { x: "0.3612", y: "0.6692", z: "-0.0613" },
    { x: "0.3154", y: "0.5873", z: "-0.0252" },
    { x: "0.3572", y: "0.5252", z: "-0.0577" },
    { x: "0.3563", y: "0.6023", z: "-0.0723" },
    { x: "0.3382", y: "0.6623", z: "-0.0701" },
    { x: "0.2923", y: "0.5832", z: "-0.0332" },
    { x: "0.3342", y: "0.5212", z: "-0.0643" },
    { x: "0.3332", y: "0.5972", z: "-0.0772" },
    { x: "0.3152", y: "0.6562", z: "-0.0732" },
    { x: "0.2682", y: "0.5772", z: "-0.0402" },
    { x: "0.3102", y: "0.5152", z: "-0.0682" },
    { x: "0.3092", y: "0.5902", z: "-0.0782" },
    { x: "0.2912", y: "0.6472", z: "-0.0722" }
  ]
},
{
  letra: "O",
  puntos: [
    { x: "0.2559", y: "0.9384", z: "0.0000" },
    { x: "0.3051", y: "0.8680", z: "-0.0263" },
    { x: "0.3208", y: "0.7699", z: "-0.0391" },
    { x: "0.2860", y: "0.7086", z: "-0.0538" },
    { x: "0.2412", y: "0.6734", z: "-0.0665" },
    { x: "0.2738", y: "0.6479", z: "-0.0183" },
    { x: "0.2750", y: "0.5408", z: "-0.0461" },
    { x: "0.2715", y: "0.4758", z: "-0.0636" },
    { x: "0.2648", y: "0.4179", z: "-0.0742" },
    { x: "0.2262", y: "0.6552", z: "-0.0263" },
    { x: "0.2276", y: "0.5327", z: "-0.0587" },
    { x: "0.2283", y: "0.4559", z: "-0.0768" },
    { x: "0.2249", y: "0.3926", z: "-0.0847" },
    { x: "0.1815", y: "0.6917", z: "-0.0380" },
    { x: "0.1886", y: "0.6095", z: "-0.0857" },
    { x: "0.2247", y: "0.6692", z: "-0.0904" },
    { x: "0.2456", y: "0.7211", z: "-0.0799" },
    { x: "0.1458", y: "0.7480", z: "-0.0518" },
    { x: "0.1758", y: "0.7087", z: "-0.0909" },
    { x: "0.2107", y: "0.7493", z: "-0.0915" },
    { x: "0.2279", y: "0.7874", z: "-0.0820" }
  ]
},
{
  letra: "P",
  puntos: [
    { x: "0.2351", y: "0.8727", z: "0.0000" },
    { x: "0.2960", y: "0.8244", z: "-0.0312" },
    { x: "0.3368", y: "0.7375", z: "-0.0485" },
    { x: "0.3312", y: "0.6698", z: "-0.0664" },
    { x: "0.2967", y: "0.6187", z: "-0.0819" },
    { x: "0.2960", y: "0.5857", z: "-0.0259" },
    { x: "0.3017", y: "0.4781", z: "-0.0549" },
    { x: "0.3022", y: "0.4159", z: "-0.0738" },
    { x: "0.3023", y: "0.3598", z: "-0.0870" },
    { x: "0.2450", y: "0.5831", z: "-0.0333" },
    { x: "0.2513", y: "0.4599", z: "-0.0661" },
    { x: "0.2712", y: "0.3952", z: "-0.0845" },
    { x: "0.2874", y: "0.3441", z: "-0.0949" },
    { x: "0.1971", y: "0.6117", z: "-0.0453" },
    { x: "0.2237", y: "0.5124", z: "-0.0941" },
    { x: "0.2633", y: "0.5698", z: "-0.1037" },
    { x: "0.2849", y: "0.6256", z: "-0.0998" },
    { x: "0.1589", y: "0.6640", z: "-0.0596" },
    { x: "0.2083", y: "0.6436", z: "-0.1067" },
    { x: "0.2437", y: "0.6827", z: "-0.1188" },
    { x: "0.2593", y: "0.7169", z: "-0.1189" }
  ]
},
{
  letra: "Q",
  puntos: [
    { x: "0.2351", y: "0.8727", z: "0.0000" },
    { x: "0.2960", y: "0.8244", z: "-0.0312" },
    { x: "0.3368", y: "0.7375", z: "-0.0485" },
    { x: "0.3312", y: "0.6698", z: "-0.0664" },
    { x: "0.2967", y: "0.6187", z: "-0.0819" },
    { x: "0.2960", y: "0.5857", z: "-0.0259" },
    { x: "0.3017", y: "0.4781", z: "-0.0549" },
    { x: "0.3022", y: "0.4159", z: "-0.0738" },
    { x: "0.3023", y: "0.3598", z: "-0.0870" },
    { x: "0.2450", y: "0.5831", z: "-0.0333" },
    { x: "0.2513", y: "0.4599", z: "-0.0661" },
    { x: "0.2712", y: "0.3952", z: "-0.0845" },
    { x: "0.2874", y: "0.3441", z: "-0.0949" },
    { x: "0.1971", y: "0.6117", z: "-0.0453" },
    { x: "0.2237", y: "0.5124", z: "-0.0941" },
    { x: "0.2633", y: "0.5698", z: "-0.1037" },
    { x: "0.2849", y: "0.6256", z: "-0.0998" },
    { x: "0.1589", y: "0.6640", z: "-0.0596" },
    { x: "0.2083", y: "0.6436", z: "-0.1067" },
    { x: "0.2437", y: "0.6827", z: "-0.1188" },
    { x: "0.2593", y: "0.7169", z: "-0.1189" }
  ]
},
{
  letra: "R",
  puntos: [
    { x: "0.2351", y: "0.8727", z: "0.0000" },
    { x: "0.2960", y: "0.8244", z: "-0.0312" },
    { x: "0.3368", y: "0.7375", z: "-0.0485" },
    { x: "0.3312", y: "0.6698", z: "-0.0664" },
    { x: "0.2967", y: "0.6187", z: "-0.0819" },
    { x: "0.2960", y: "0.5857", z: "-0.0259" },
    { x: "0.3017", y: "0.4781", z: "-0.0549" },
    { x: "0.3022", y: "0.4159", z: "-0.0738" },
    { x: "0.3023", y: "0.3598", z: "-0.0870" },
    { x: "0.2450", y: "0.5831", z: "-0.0333" },
    { x: "0.2513", y: "0.4599", z: "-0.0661" },
    { x: "0.2712", y: "0.3952", z: "-0.0845" },
    { x: "0.2874", y: "0.3441", z: "-0.0949" },
    { x: "0.1971", y: "0.6117", z: "-0.0453" },
    { x: "0.2237", y: "0.5124", z: "-0.0941" },
    { x: "0.2633", y: "0.5698", z: "-0.1037" },
    { x: "0.2849", y: "0.6256", z: "-0.0998" },
    { x: "0.1589", y: "0.6640", z: "-0.0596" },
    { x: "0.2083", y: "0.6436", z: "-0.1067" },
    { x: "0.2437", y: "0.6827", z: "-0.1188" },
    { x: "0.2593", y: "0.7169", z: "-0.1189" }
  ]
},
{
  letra: "RR",
  puntos: [
    { x: "0.4445", y: "1.0322", z: "0.0000" },
    { x: "0.5204", y: "1.0028", z: "-0.0231" },
    { x: "0.5759", y: "0.9241", z: "-0.0399" },
    { x: "0.5964", y: "0.8437", z: "-0.0603" },
    { x: "0.5903", y: "0.7701", z: "-0.0767" },
    { x: "0.5582", y: "0.7826", z: "-0.0233" },
    { x: "0.6121", y: "0.6709", z: "-0.0552" },
    { x: "0.6432", y: "0.6157", z: "-0.0725" },
    { x: "0.6653", y: "0.5637", z: "-0.0835" },
    { x: "0.5150", y: "0.7571", z: "-0.0356" },
    { x: "0.5721", y: "0.6201", z: "-0.0744" },
    { x: "0.6297", y: "0.5698", z: "-0.0891" },
    { x: "0.6712", y: "0.5206", z: "-0.0941" },
    { x: "0.4685", y: "0.7627", z: "-0.0518" },
    { x: "0.5399", y: "0.6715", z: "-0.1046" },
    { x: "0.5571", y: "0.7633", z: "-0.1024" },
    { x: "0.5473", y: "0.8238", z: "-0.0880" },
    { x: "0.4268", y: "0.7986", z: "-0.0700" },
    { x: "0.5067", y: "0.8089", z: "-0.1170" },
    { x: "0.5270", y: "0.8643", z: "-0.1210" },
    { x: "0.5147", y: "0.8947", z: "-0.1145" }
  ]
},
{
  letra: "S",
  puntos: [
    { x: "0.1901", y: "0.7623", z: "-0.0000" },
    { x: "0.2475", y: "0.7166", z: "-0.0220" },
    { x: "0.3049", y: "0.6280", z: "-0.0328" },
    { x: "0.3098", y: "0.5446", z: "-0.0420" },
    { x: "0.2742", y: "0.5030", z: "-0.0451" },
    { x: "0.2317", y: "0.5265", z: "-0.0092" },
    { x: "0.2810", y: "0.5011", z: "-0.0391" },
    { x: "0.2740", y: "0.5772", z: "-0.0512" },
    { x: "0.2488", y: "0.5849", z: "-0.0582" },
    { x: "0.1898", y: "0.5233", z: "-0.0126" },
    { x: "0.2434", y: "0.5009", z: "-0.0471" },
    { x: "0.2427", y: "0.5948", z: "-0.0519" },
    { x: "0.2172", y: "0.5993", z: "-0.0493" },
    { x: "0.1526", y: "0.5359", z: "-0.0206" },
    { x: "0.2026", y: "0.5165", z: "-0.0579" },
    { x: "0.2104", y: "0.6077", z: "-0.0448" },
    { x: "0.1848", y: "0.6189", z: "-0.0293" },
    { x: "0.1143", y: "0.5605", z: "-0.0302" },
    { x: "0.1638", y: "0.5560", z: "-0.0536" },
    { x: "0.1748", y: "0.6173", z: "-0.0436" },
    { x: "0.1530", y: "0.6272", z: "-0.0313" }
  ]
},
{
  letra: "T",
  puntos: [
    { x: "0.4171", y: "0.8560", z: "0.0000" },
    { x: "0.4806", y: "0.8090", z: "-0.0058" },
    { x: "0.5203", y: "0.7207", z: "-0.0163" },
    { x: "0.5531", y: "0.6631", z: "-0.0314" },
    { x: "0.5992", y: "0.6368", z: "-0.0475" },
    { x: "0.5007", y: "0.5879", z: "-0.0143" },
    { x: "0.5209", y: "0.4864", z: "-0.0516" },
    { x: "0.5550", y: "0.4762", z: "-0.0817" },
    { x: "0.5888", y: "0.4858", z: "-0.1008" },
    { x: "0.4691", y: "0.5895", z: "-0.0338" },
    { x: "0.4832", y: "0.4653", z: "-0.0614" },
    { x: "0.5019", y: "0.3905", z: "-0.0855" },
    { x: "0.5173", y: "0.3257", z: "-0.1044" },
    { x: "0.4352", y: "0.6187", z: "-0.0570" },
    { x: "0.4425", y: "0.4992", z: "-0.0855" },
    { x: "0.4544", y: "0.4267", z: "-0.1050" },
    { x: "0.4664", y: "0.3599", z: "-0.1194" },
    { x: "0.3997", y: "0.6675", z: "-0.0809" },
    { x: "0.4023", y: "0.5873", z: "-0.1085" },
    { x: "0.4088", y: "0.5317", z: "-0.1211" },
    { x: "0.4155", y: "0.4751", z: "-0.1304" }
  ]
},
{
  letra: "U",
  puntos: [
    { x: "0.2559", y: "0.9384", z: "0.0000" },
    { x: "0.3051", y: "0.8680", z: "-0.0263" },
    { x: "0.3208", y: "0.7699", z: "-0.0391" },
    { x: "0.2860", y: "0.7086", z: "-0.0538" },
    { x: "0.2412", y: "0.6734", z: "-0.0665" },
    { x: "0.2738", y: "0.6479", z: "-0.0183" },
    { x: "0.2750", y: "0.5408", z: "-0.0461" },
    { x: "0.2715", y: "0.4758", z: "-0.0636" },
    { x: "0.2648", y: "0.4179", z: "-0.0742" },
    { x: "0.2262", y: "0.6552", z: "-0.0263" },
    { x: "0.2276", y: "0.5327", z: "-0.0587" },
    { x: "0.2283", y: "0.4559", z: "-0.0768" },
    { x: "0.2249", y: "0.3926", z: "-0.0847" },
    { x: "0.1815", y: "0.6917", z: "-0.0380" },
    { x: "0.1886", y: "0.6095", z: "-0.0857" },
    { x: "0.2247", y: "0.6692", z: "-0.0904" },
    { x: "0.2456", y: "0.7211", z: "-0.0799" },
    { x: "0.1458", y: "0.7480", z: "-0.0518" },
    { x: "0.1758", y: "0.7087", z: "-0.0909" },
    { x: "0.2107", y: "0.7493", z: "-0.0915" },
    { x: "0.2279", y: "0.7874", z: "-0.0820" }
  ]
},
{
  letra: "V",
  puntos: [
    { x: "0.2372", y: "0.9077", z: "-0.0000" },
    { x: "0.2922", y: "0.8707", z: "-0.0310" },
    { x: "0.3275", y: "0.7992", z: "-0.0551" },
    { x: "0.3431", y: "0.7412", z: "-0.0753" },
    { x: "0.3468", y: "0.6864", z: "-0.0922" },
    { x: "0.3066", y: "0.6951", z: "-0.0303" },
    { x: "0.3122", y: "0.5982", z: "-0.0659" },
    { x: "0.3123", y: "0.5374", z: "-0.0863" },
    { x: "0.3099", y: "0.4812", z: "-0.0995" },
    { x: "0.2672", y: "0.6932", z: "-0.0381" },
    { x: "0.2733", y: "0.5892", z: "-0.0732" },
    { x: "0.2762", y: "0.5232", z: "-0.0917" },
    { x: "0.2752", y: "0.4642", z: "-0.1022" },
    { x: "0.2282", y: "0.6952", z: "-0.0452" },
    { x: "0.2342", y: "0.5892", z: "-0.0783" },
    { x: "0.2372", y: "0.5202", z: "-0.0942" },
    { x: "0.2362", y: "0.4582", z: "-0.1023" },
    { x: "0.1892", y: "0.7022", z: "-0.0512" },
    { x: "0.1952", y: "0.5982", z: "-0.0822" },
    { x: "0.1982", y: "0.5302", z: "-0.0962" },
    { x: "0.1972", y: "0.4682", z: "-0.1022" }
  ]
},
{
  letra: "W",
  puntos: [
    { x: "0.2372", y: "0.9077", z: "-0.0000" },
    { x: "0.2922", y: "0.8707", z: "-0.0310" },
    { x: "0.3275", y: "0.7992", z: "-0.0551" },
    { x: "0.3431", y: "0.7412", z: "-0.0753" },
    { x: "0.3468", y: "0.6864", z: "-0.0922" },
    { x: "0.3066", y: "0.6951", z: "-0.0303" },
    { x: "0.3122", y: "0.5982", z: "-0.0659" },
    { x: "0.3123", y: "0.5374", z: "-0.0863" },
    { x: "0.3099", y: "0.4812", z: "-0.0995" },
    { x: "0.2672", y: "0.6932", z: "-0.0381" },
    { x: "0.2733", y: "0.5892", z: "-0.0732" },
    { x: "0.2762", y: "0.5232", z: "-0.0917" },
    { x: "0.2752", y: "0.4642", z: "-0.1022" },
    { x: "0.2282", y: "0.6952", z: "-0.0452" },
    { x: "0.2342", y: "0.5892", z: "-0.0783" },
    { x: "0.2372", y: "0.5202", z: "-0.0942" },
    { x: "0.2362", y: "0.4582", z: "-0.1023" },
    { x: "0.1892", y: "0.7022", z: "-0.0512" },
    { x: "0.1952", y: "0.5982", z: "-0.0822" },
    { x: "0.1982", y: "0.5302", z: "-0.0962" },
    { x: "0.1972", y: "0.4682", z: "-0.1022" }
  ]
},
{
  letra: "X",
  puntos: [
    { x: "0.2372", y: "0.9077", z: "-0.0000" },
    { x: "0.2922", y: "0.8707", z: "-0.0310" },
    { x: "0.3275", y: "0.7992", z: "-0.0551" },
    { x: "0.3431", y: "0.7412", z: "-0.0753" },
    { x: "0.3468", y: "0.6864", z: "-0.0922" },
    { x: "0.3066", y: "0.6951", z: "-0.0303" },
    { x: "0.3122", y: "0.5982", z: "-0.0659" },
    { x: "0.3123", y: "0.5374", z: "-0.0863" },
    { x: "0.3099", y: "0.4812", z: "-0.0995" },
    { x: "0.2672", y: "0.6932", z: "-0.0381" },
    { x: "0.2733", y: "0.5892", z: "-0.0732" },
    { x: "0.2762", y: "0.5232", z: "-0.0917" },
    { x: "0.2752", y: "0.4642", z: "-0.1022" },
    { x: "0.2282", y: "0.6952", z: "-0.0452" },
    { x: "0.2342", y: "0.5892", z: "-0.0783" },
    { x: "0.2372", y: "0.5202", z: "-0.0942" },
    { x: "0.2362", y: "0.4582", z: "-0.1023" },
    { x: "0.1892", y: "0.7022", z: "-0.0512" },
    { x: "0.1952", y: "0.5982", z: "-0.0822" },
    { x: "0.1982", y: "0.5302", z: "-0.0962" },
    { x: "0.1972", y: "0.4682", z: "-0.1022" }
  ]
},
{
  letra: "Y",
  puntos: [
    { x: "0.2372", y: "0.9077", z: "0.0000" },
    { x: "0.2922", y: "0.8707", z: "-0.0310" },
    { x: "0.3275", y: "0.7992", z: "-0.0551" },
    { x: "0.3431", y: "0.7412", z: "-0.0753" },
    { x: "0.3468", y: "0.6864", z: "-0.0922" },
    { x: "0.3066", y: "0.6951", z: "-0.0303" },
    { x: "0.3122", y: "0.5982", z: "-0.0659" },
    { x: "0.3123", y: "0.5374", z: "-0.0863" },
    { x: "0.3099", y: "0.4812", z: "-0.0995" },
    { x: "0.2672", y: "0.6932", z: "-0.0381" },
    { x: "0.2733", y: "0.5892", z: "-0.0732" },
    { x: "0.2762", y: "0.5232", z: "-0.0917" },
    { x: "0.2752", y: "0.4642", z: "-0.1022" },
    { x: "0.2282", y: "0.6952", z: "-0.0452" },
    { x: "0.2342", y: "0.5892", z: "-0.0783" },
    { x: "0.2372", y: "0.5202", z: "-0.0942" },
    { x: "0.2362", y: "0.4582", z: "-0.1023" },
    { x: "0.1892", y: "0.7022", z: "-0.0512" },
    { x: "0.1952", y: "0.5982", z: "-0.0822" },
    { x: "0.1982", y: "0.5302", z: "-0.0962" },
    { x: "0.1972", y: "0.4682", z: "-0.1022" }
  ]
},
{
  letra: "Z",
  puntos: [
    { x: "0.2372", y: "0.9077", z: "0.0000" },
    { x: "0.2922", y: "0.8707", z: "-0.0310" },
    { x: "0.3275", y: "0.7992", z: "-0.0551" },
    { x: "0.3431", y: "0.7412", z: "-0.0753" },
    { x: "0.3468", y: "0.6864", z: "-0.0922" },
    { x: "0.3066", y: "0.6951", z: "-0.0303" },
    { x: "0.3122", y: "0.5982", z: "-0.0659" },
    { x: "0.3123", y: "0.5374", z: "-0.0863" },
    { x: "0.3099", y: "0.4812", z: "-0.0995" },
    { x: "0.2672", y: "0.6932", z: "-0.0381" },
    { x: "0.2733", y: "0.5892", z: "-0.0732" },
    { x: "0.2762", y: "0.5232", z: "-0.0917" },
    { x: "0.2752", y: "0.4642", z: "-0.1022" },
    { x: "0.2282", y: "0.6952", z: "-0.0452" },
    { x: "0.2342", y: "0.5892", z: "-0.0783" },
    { x: "0.2372", y: "0.5202", z: "-0.0942" },
    { x: "0.2362", y: "0.4582", z: "-0.1023" },
    { x: "0.1892", y: "0.7022", z: "-0.0512" },
    { x: "0.1952", y: "0.5982", z: "-0.0822" },
    { x: "0.1982", y: "0.5302", z: "-0.0962" },
    { x: "0.1972", y: "0.4682", z: "-0.1022" }
  ]
}

];

// 丘뙖잺 Variables Globales
let currentUser = "";
let currentPartner = "";
let camera = null; // Global camera variable
let hands = null; // Global hands variable
let indiceEntrena = 0;
let tiempoSosteniendo = 0;
let ultimaLetraDetectada = "";
let tiempoSinMano = 0;
let intervaloDeteccion = null;

/* =========================================
   2. L칍GICA DE INTERFAZ Y NAVEGACI칍N
   ========================================= */

function hideAllScreens() {
  const screens = ["login", "register", "recover", "app-interface", "entrenamiento-overlay", "backToUsersBtn"];
  screens.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.classList.add("hidden");
    }
  });
}

function showRegister() {
  hideAllScreens();
  document.getElementById("register").classList.remove("hidden");
}

function showRecover() {
  hideAllScreens();
  document.getElementById("recover").classList.remove("hidden");
}

function showLogin() {
  hideAllScreens();
  document.getElementById("login").classList.remove("hidden");
}

function createAccount() {
  alert("Cuenta simulada creada con 칠xito. Por favor inicia sesi칩n.");
  showLogin();
}

function sendRecoveryLink() {
  alert("Enlace enviado (simulado). Revisa tu correo.");
  showLogin();
}

// Mostrar la Interfaz Principal (Layout tipo WhatsApp)
function mostrarInterfazApp() {
  hideAllScreens();
  const appInterface = document.getElementById("app-interface");
    if (appInterface) {
        appInterface.classList.remove("hidden");
    }
  const saludoShort = document.getElementById("userGreetingShort");
  if (saludoShort) saludoShort.textContent = currentUser;
  const userAvatar = document.getElementById("userAvatar");
    if (userAvatar) {
        userAvatar.src = avatarURL;
    }
}

function login() {
  const user = document.getElementById("loginUsername").value.trim();
  const pass = document.getElementById("loginPassword").value.trim();
  const dataUser = JSON.parse(localStorage.getItem("usuario_" + user));

  if (!dataUser || dataUser.pass !== pass) {
    alert("Usuario o contrase침a incorrectos.");
    return;
  }

  currentUser = user;
  localStorage.setItem("usuarioActivo", user);

  if (dataUser.nuevo) {
    dataUser.nuevo = false;
    localStorage.setItem("usuario_" + user, JSON.stringify(dataUser));
    mostrarEntrenamiento();
  } else {
    mostrarInterfazApp();
  }
}
// Verifica la sesi칩n al cargar la p치gina (Funci칩n que faltaba)
function checkLogin() {
  const usuarioGuardado = localStorage.getItem("usuarioActivo");
  
  if (usuarioGuardado) {
    // Si hay un usuario activo, cargamos sus datos y verificamos si es nuevo.
    currentUser = usuarioGuardado;
    
    const dataUser = JSON.parse(localStorage.getItem("usuario_" + currentUser));
    
    if (dataUser && dataUser.nuevo) {
      // Si es nuevo, forzamos el entrenamiento.
      mostrarEntrenamiento();
    } else {
      // Si no es nuevo, mostramos la interfaz principal.
      mostrarInterfazApp();
    }
  } else {
    // Si no hay usuario activo, mostramos el formulario de login.
    showLogin();
  }
}

// ... [Tu funci칩n logout() va aqu칤] ...
function logout() {
  localStorage.removeItem("usuarioActivo");
  currentUser = "";
  document.getElementById("loginUsername").value = "";
  document.getElementById("loginPassword").value = "";

  // Clear Camera and Hands
  if (hands) {
    hands.close();
    hands = null;
  }
  if (camera && camera.stop) {
    camera.stop();
    camera = null;
  }

  hideAllScreens();
  document.getElementById("login").classList.remove("hidden");
}


/* =========================================
   3. INICIALIZACI칍N DE MEDIAPIPE (C츼MARA Y MODELO)
   ========================================= */

async function iniciarMediaPipe(videoId, canvasId, callbackLogica) {
    const videoElement = document.getElementById(videoId);
    const canvasElement = document.getElementById(canvasId);

    if (!videoElement || !canvasElement) {
        console.warn(`Element with videoId ${videoId} or canvasId ${canvasId} not found.`);
        return;
    }

    const canvasCtx = canvasElement.getContext("2d");

    // 1. DETENER Y LIMPIAR C츼MARA ANTERIOR
    if (camera && camera.stop) {
        camera.stop();
        camera = null;
    }
    if (hands) {
        await hands.close();
        hands = null;
    }

    // Muestra el elemento de video y FUERZA SU TAMA칌O antes de inicializar la c치mara
    videoElement.classList.remove("hidden");
    videoElement.style.display = 'block';
    videoElement.width = 640; // Asegura que el video tenga dimensiones al iniciar
    videoElement.height = 480;

    // 2. INICIALIZACI칍N DEL MODELO HANDS (El resto de la configuraci칩n est치 OK)
    hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`,
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
    });

    // 3. RESULTADOS (DIBUJO Y L칍GICA)
    hands.onResults(async (results) => {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        // Aplicar la transformaci칩n de espejo UNA SOLA VEZ
        canvasCtx.translate(canvasElement.width, 0);
        canvasCtx.scale(-1, 1);

        // Dibuja la imagen de la c치mara en el canvas (todo lo que venga despu칠s estar치 volteado)
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        let manoDetectada = false;
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            manoDetectada = true;
            for (const landmarks of results.multiHandLandmarks) {
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, { color: "#00FF00", lineWidth: 2 });
                drawLandmarks(canvasCtx, landmarks, { color: "#FF0000", lineWidth: 1 });

                callbackLogica(landmarks[0], manoDetectada);
            }
        } else {
            callbackLogica(null, false);
        }
        canvasCtx.restore(); // Restaura el contexto original
    });

    // 4. INICIALIZACI칍N DE LA C츼MARA (El resto est치 OK)
    camera = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({ image: videoElement });
        },
        width: 640,
        height: 480
    });

    camera.start(); // Inicia el flujo
}

/* =========================================
   4. M칍DULO DE ENTRENAMIENTO
   ========================================= */

function mostrarEntrenamiento() {
  hideAllScreens();
  document.getElementById("app-interface").classList.add("hidden");
  document.getElementById("entrenamiento-overlay").classList.remove("hidden");

  indiceEntrena = 0;
  tiempoSosteniendo = 0;

  iniciarMediaPipe("videoEntrena", "canvasEntrena", logicaEntrenamiento);
  cargarLetraEntrenamiento();
}

function cargarLetraEntrenamiento() {
    // 1. DEFINIR LA VARIABLE 'letra' AL PRINCIPIO
    let letra = abecedario[indiceEntrena];

    // Saltamos letras si no hay data de ejemplo (validaci칩n de seguridad)
    while (indiceEntrena < abecedario.length && !ejemplosGuardados.some(e => e.letra === letra)) {
        console.warn(`Saltando: No hay data de entrenamiento para ${letra}`);
        indiceEntrena++;
        if (indiceEntrena >= abecedario.length) break;
        letra = abecedario[indiceEntrena];
    }

    // Si ya se acab칩 el abecedario, terminamos
    if (indiceEntrena >= abecedario.length) {
        mostrarFinEntrenamiento();
        return;
    }

    // 2. L칍GICA DE IMAGEN DE REFERENCIA CON PROTECCI칍N DE ERROR
    const imgRef = document.getElementById("imagenReferencia");
    
    // A칌ADIMOS ESTA VERIFICACI칍N CR칈TICA:
    if (imgRef) {
        // Asignamos la ruta de la imagen, USANDO LA EXTENSI칍N .png
        imgRef.src = `img/${letra.toLowerCase()}.png`;

        // Si la imagen falla, ponemos el cuadro gris (placeholder)
        imgRef.onerror = function() {
            this.src = "https://via.placeholder.com/150?text=" + letra;
            console.warn("Falta la imagen para la letra: " + letra);
        };
    } else {
        // Mensaje de ayuda si el elemento HTML falta
        console.error("FATAL: Falta la etiqueta <img id=\"imagenReferencia\"> en el HTML.");
    }

    // 3. ACTUALIZAR INTERFAZ (Se mantiene con verificaciones)
    
    const letraGigante = document.getElementById("letraGigante");
    if (letraGigante) letraGigante.textContent = letra;

    const progresoDiv = document.getElementById("progresoEntrenamiento");
    if (progresoDiv) progresoDiv.classList.remove("hidden");
    
    const barraProgreso = document.getElementById("barraProgreso");
    if (barraProgreso) barraProgreso.style.width = `${(indiceEntrena / abecedario.length) * 100}%`;
    
    const statusEntrena = document.getElementById("statusEntrena"); 
    if (statusEntrena) statusEntrena.textContent = `Mant칠n la se침a de la ${letra} durante 2 segundos.`;
}

function logicaEntrenamiento(landmarks, manoDetectada) {
  if (indiceEntrena >= abecedario.length) return; // Ya termin칩

  const barraProgreso = document.getElementById("barraProgreso");
  let letraActual = abecedario[indiceEntrena];
  const mensaje = document.getElementById("instruccion");

  if (manoDetectada) {
    // Buscar si la mano detectada coincide con la letra objetivo
    if (compararMano(landmarks, letraActual)) {
      tiempoSosteniendo += 100; // Simulaci칩n de 100ms de detecci칩n
      let progreso = Math.min(100, (tiempoSosteniendo / 2000) * 100); // 2000ms = 2s

      barraProgreso.style.backgroundColor = '#25d366';
      mensaje.textContent = `춰Correcto! Sost칠n por ${Math.ceil((2000 - tiempoSosteniendo) / 1000)}s m치s.`;

      if (progreso >= 100) {
        // Transici칩n a la siguiente letra
        tiempoSosteniendo = 0;
        indiceEntrena++;
        cargarLetraEntrenamiento();
      }
    } else {
      // Se detect칩 una mano, pero la se침a es incorrecta
      tiempoSosteniendo = 0;
      barraProgreso.style.backgroundColor = '#ff4d4d'; // Rojo
      mensaje.textContent = `Se침a incorrecta. Intenta la se침a de la letra ${letraActual}.`;
    }
  } else {
    // No hay mano visible
    tiempoSosteniendo = 0;
    barraProgreso.style.backgroundColor = '#ccc'; // Gris
    mensaje.textContent = "Coloca tu mano frente a la c치mara para iniciar.";
  }

  // Actualizar visualmente la barra de progreso
  barraProgreso.style.width = `${Math.min(100, (tiempoSosteniendo / 2000) * 100)}%`;
}

async function mostrarFinEntrenamiento() {
  // Limpiar c치mara al finalizar
  if (camera && camera.stop) {
    camera.stop();
    camera = null;
  }
  if (hands) {
      await hands.close();
      hands = null;
  }

  const entrenamientoDiv = document.getElementById("entrenamiento");
  entrenamientoDiv.innerHTML = `
    <h2 id="tituloLetra">춰Entrenamiento Completo! 游봅</h2>
    <p id="instruccion">Has aprendido todo el abecedario. Ahora puedes usar el chat para comunicarte por se침as.</p>
    <button onclick="mostrarInterfazApp()">Ir al Chat</button>
  `;
}


/* =========================================
   5. MOTOR DE IA (RECONOCIMIENTO Y L칍GICA)
   ========================================= */

// Funci칩n matem치tica para comparar tu mano con la base de datos
function compararMano(landmarks, letraObjetivo) {
  const ejemplo = ejemplosGuardados.find(e => e.letra === letraObjetivo);
  if (!ejemplo) return false;

  let errorTotal = 0;
  // Comparamos los 21 puntos de la mano
  for (let i = 0; i < 21; i++) {
    // Coordenadas en tiempo real
    const x1 = landmarks[i].x;
    const y1 = landmarks[i].y;

    // Datos guardados
    const x2 = parseFloat(ejemplo.puntos[i].x);
    const y2 = parseFloat(ejemplo.puntos[i].y);

    // Distancia Euclidiana simple (solo X e Y, ignorando Z por simplicidad)
    const dist = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
    errorTotal += dist;
  }

  // Umbral de sensibilidad (aj칰stalo: menor n칰mero = m치s estricto)
  return errorTotal < 1.5;
}

/* =========================================
   6. M칍DULO DE CHAT Y COMUNICACI칍N
   ========================================= */

async function toggleModoSe침as() {
    const panel = document.getElementById("panelCamaraChat");

    // Si el panel est치 OCULTO (hidden), lo abrimos e INICIAMOS la c치mara.
    if (panel.classList.contains("hidden")) {
        panel.classList.remove("hidden");

        // INICIAMOS MediaPipe
        iniciarMediaPipe("videoChat", "canvasChat", logicaChatSe침as);

    }
    // Si el panel est치 VISIBLE, lo cerramos y DETENEMOS la c치mara/MediaPipe.
    else {
        panel.classList.add("hidden");

        // LIMPIEZA EXPL칈CITA
        if (camera && camera.stop) {
            camera.stop();
            camera = null;
        }
        if (hands) {
            await hands.close();
            hands = null;
        }
    }
}

function logicaChatSe침as(landmarks, manoDetectada) {
  const previewTxt = document.getElementById("textoDetectadoPreview");
  if (!previewTxt) return; // Asegurar que el elemento existe

  if (!manoDetectada) {
    tiempoSinMano += 100;
    if (tiempoSinMano >= 3000) { // 3 Segundos sin mano -> Espacio
      previewTxt.value += " ";
      tiempoSinMano = 0;
    }
    return;
  }

  tiempoSinMano = 0; // Reiniciar contador de inactividad

  // Buscar qu칠 letra es
  let letraEncontrada = null;
  for (let l of abecedario) {
    if (compararMano(landmarks, l)) {
      letraEncontrada = l;
      break;
    }
  }

  if (letraEncontrada && letraEncontrada !== ultimaLetraDetectada) {
    // Evita escribir la misma letra m칰ltiples veces por la misma se침a
    previewTxt.value += letraEncontrada;
    ultimaLetraDetectada = letraEncontrada;

    // Peque침o delay para permitir que la mano se mueva a la siguiente se침a
    setTimeout(() => {
      ultimaLetraDetectada = "";
    }, 1000);
  }
}

function enviarTextoSe침as() {
  const texto = document.getElementById("textoDetectadoPreview").value;
  if (texto) {
    agregarBurbuja(texto, "outgoing");
    document.getElementById("textoDetectadoPreview").value = "";
    toggleModoSe침as(); // Cerrar c치mara
  }
}

function agregarBurbuja(texto, tipo) {
  const messagesDiv = document.getElementById("messages");
  const burbuja = document.createElement("div");
  burbuja.className = `bubble ${tipo}`; // Usa .bubble.incoming o .bubble
  burbuja.textContent = texto;
  messagesDiv.appendChild(burbuja);
  // Scroll al 칰ltimo mensaje
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Funciones de navegaci칩n del Chat (se asume que existe la interfaz)
function abrirChat(nombre) {
  currentPartner = nombre;
  const chatTitle = document.getElementById("chatTitle");
  if (chatTitle) chatTitle.innerText = "Chat con " + nombre;
  // L칩gica para responsive (ocultar lista en m칩vil)
  if (window.innerWidth <= 768) {
    document.getElementById("userList").classList.add("hidden");
    document.getElementById("chat-area").classList.remove("hidden");
    const btnBack = document.getElementById("backToUsersBtn");
    if (btnBack) btnBack.classList.remove("hidden");
  }
  // Mostrar chat
  document.getElementById("entrenamiento").classList.add("hidden");
  document.getElementById("chat").classList.remove("hidden");
  // Mensaje de bienvenida
  const messagesDiv = document.getElementById("messages");
  messagesDiv.innerHTML = `<div class="bubble incoming">Has iniciado conversaci칩n con ${nombre}</div>`;
}

function goBackToUsers() {
  if (window.innerWidth <= 768) {
    document.getElementById("userList").classList.remove("hidden");
    document.getElementById("chat-area").classList.add("hidden");
    const btnBack = document.getElementById("backToUsersBtn");
    if (btnBack) btnBack.classList.add("hidden");
  }
}

/* =========================================
   7. INICIALIZACI칍N
   ========================================= */

window.onload = function() {
  // Comprobar si ya hay sesi칩n iniciada
  const usuarioGuardado = localStorage.getItem("usuarioActivo");

  if (usuarioGuardado) {
    currentUser = usuarioGuardado;
    // Si el usuario guardado es nuevo (por si no termin칩 la sesi칩n anterior)
    const dataUser = JSON.parse(localStorage.getItem("usuario_" + currentUser));
    if (dataUser && dataUser.nuevo) {
      mostrarEntrenamiento();
    } else {
      mostrarInterfazApp();
    }
  } else {
    showLogin();
  }
}

// L칩gica de Registro (Se asume que hay un formulario de registro)
function registerUser() {
  const newUser = document.getElementById("registerUsername").value.trim();
  const newPass = document.getElementById("registerPassword").value.trim();
  const confirmPass = document.getElementById("registerConfirmPassword").value.trim();
  const avatarRadio = document.querySelector('input[name="avatar"]:checked');
  const newAvatar = avatarRadio ? avatarRadio.value : avatarURL;

  if (!newUser || !newPass || !confirmPass) {
    alert("Por favor, completa todos los campos.");
    return;
  }
  if (newPass !== confirmPass) {
    alert("Las contrase침as no coinciden.");
    return;
  }
  if (localStorage.getItem("usuario_" + newUser)) {
    alert("El nombre de usuario ya existe.");
    return;
  }

  const userData = {
    user: newUser,
    pass: newPass,
    avatar: newAvatar,
    nuevo: true, // Marcamos como nuevo para forzar el entrenamiento al primer login
    historial: []
  };

  localStorage.setItem("usuario_" + newUser, JSON.stringify(userData));
  alert("춰Registro exitoso! Por favor, inicia sesi칩n.");
  showLogin();
}
// Este evento garantiza que todas las variables y funciones
// (incluyendo abecedario) est칠n definidas antes de iniciar el programa.
// Solo debe haber UNA definici칩n de window.onload
window.onload = function() {
    checkLogin();
    console.log("Sistema iniciado despu칠s de la carga completa.");
};